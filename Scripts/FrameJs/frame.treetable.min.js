(function($,fns){String.prototype.replaceAll=function(s1,s2){return this.replace(new RegExp(s1,"gm"),s2);}
var methods,tree;Node=(function(){function Node(nid,pid,id){this.nid=nid;this.pid=pid;this.id=id;this.row=null;if(id==null){this.id=this.nid;}
this.id=id;this.childNodes=[];this.childDics={};this.parentNode=null;this.level=-1;this.Level=function(){return this.level;}}
Node.prototype.AddChild=function(childnode){var self=this;this.childNodes.push(childnode);this.childDics[childnode.nid]=childnode;childnode.parentNode=self;return this;}
Node.prototype.ChildNodes=function(){return this.childNodes;}
Node.prototype.HasChild=function(){return this.childNodes.length>0;}
Node.prototype.IsLeaf=function(){return!this.HasChild();}
Node.prototype.ChildNode=function(nid){return this.childDics[nid];}
Node.prototype.ChildNodeAt=function(index){return this.childNodes[index];}
Node.prototype.EachCHild=function(callback,args){return $.each(this.childNodes,callback,args);}
return Node;})();Tree=(function(){function Tree(table,settings){this.table=table;this.settings=settings;this.rowTag=this.settings.rowTag;this.nodeidname=this.settings.nodeIdAttr;this.pidname=this.settings.parentIdAttr;this.rootid=this.settings.rootId;this.initialState=this.settings.initialState;this.subnodeOffset=this.settings.subnodeOffset;this.openTemplate=this.settings.openTemplate;this.closeTempate=this.settings.closeTempate;this.leafTemplate=this.settings.leafTemplate;this.onExpandState=this.settings.onExpandState;this.onCollapseState=this.settings.onCollapseState;this.onStateChange=this.settings.onStateChange;this.onLoad=this.settings.onLoad;this.onLoadComplete=this.settings.onLoadComplete;this.nodedics={};this.arrnodes=[];this.rootnode=null;this.treedeep=0;this.deepdics=[];};Tree.prototype._buildtree=function(){var self=this;var rootobj=$("#"+self.rootid);if(rootobj==null)return;self.rootnode=new Node(rootobj.attr(self.nodeidname),"",self.rootid);self.rootnode.level=0;self.rootnode.row=$("#"+self.rootid);$(this.table).find(this.rowTag+"["+self.nodeidname+"]").each(function(i,val){var obj=$(this);if(obj.attr("id")==self.rootid)return;var nid=obj.attr(self.nodeidname);var pid=obj.attr(self.pidname);var id=new String(obj.attr("id")).replaceAll(" ","_");if(id==null||typeof(id)=="undefined"||id=="undefined"){id=nid.replaceAll(" ","_");obj.attr("id",id);}
var node=new Node(nid,pid,id);node.row=obj;obj.remove();self.nodedics[nid]=node;self.arrnodes[self.arrnodes.length]=node;if(pid==self.rootnode.nid){self.rootnode.AddChild(node);}});for(var key in self.arrnodes){var n=self.arrnodes[key];var pid=n.pid;var nid=n.nid;var id=n.id;if(pid!=self.rootnode.nid){self.nodedics[pid].AddChild(n);}}
self._levelc(self.rootnode);for(var key in self.arrnodes){var n=self.arrnodes[key];if(n.Level()>self.treedeep){self.treedeep=n.Level();}}}
Tree.prototype._levelc=function(node){var self=this;if(node.pid!=""&&node.pid!=null){node.level=node.parentNode.level+1;}
var prenode=node;node.EachCHild(function(i,val){this.row.insertAfter(prenode.row);prenode=this;});node.EachCHild(function(i,val){self._levelc(this);});}
Tree.prototype.Load=function(){var self=this;self._buildtree();if(self.arrnodes.length>0){if(self.initialState=="Expand"){self.ExpandAll();}else{self.CollapseAll();}}
if(self.onLoad!=null){var jsonobj={};jsonobj.obj=$("#"+self.rootid);jsonobj.parentobj=null;jsonobj.childobjs=[];self.rootnode.EachCHild(function(i,val){jsonobj.childobjs[i]=$(this.id);});jsonobj.nid=self.rootnode.nid;jsonobj.pid=self.rootnode.pid;jsonobj.isRoot=true;jsonobj.isLeaf=self.rootnode.IsLeaf();self.onLoad(jsonobj);for(var key in self.arrnodes){var n=self.arrnodes[key];jsonobj={};jsonobj.obj=$("#"+n.id);jsonobj.parentobj=$("#"+n.parentNode.id);jsonobj.childobjs=[];self.n.EachCHild(function(i,val){jsonobj.childobjs[i]=$(this.id);});jsonobj.nid=n.nid;jsonobj.pid=n.pid;jsonobj.isRoot=false;jsonobj.isLeaf=n.IsLeaf();self.onLoadComplete(jsonobj);}}
if(self.onLoadComplete!=null){self.onLoadComplete(self);}};Tree.prototype.Node=function(nid){if(nid==this.rootnode.nid){return this.rootnode;}else{return this.nodedics[nid];}}
Tree.prototype.RenderNode=function(nid,includeChild){if(!includeChild)includeChild=true;var self=this;var node=self.Node(nid);var obj=$("#"+node.id);var c=obj.find("[treeclick='true']");if(node.id==self.rootid){c.css("margin-left","0px");}else{var parent=$("#"+node.parentNode.id);var parentOffset=parent.find("[treeclick='true']").css("margin-left");var offsetint=(parentOffset==null||parentOffset=="")?parseInt(self.subnodeOffset):(parseInt(String.prototype.replace.apply(parentOffset,["px",""]))+parseInt(self.subnodeOffset));var offset=offsetint+"px";c.css("margin-left",offset);}
if(includeChild){if(node.HasChild()){var children=node.ChildNodes();for(var key in children){var n=children[key];self.RenderNode(n.nid);}}}};Tree.prototype._ExpandNode=function(nid){var self=this;var node=self.Node(nid);var curobj=$("#"+node.id);curobj.attr("childExpanded","true");var isLeaf=node.IsLeaf();if(self.onStateChange!=null){var c=self.onStateChange(curobj,true,isLeaf);self.RenderNode(nid,false);if(!isLeaf){$(c).click(function(){self.Collapse(nid);});}}};Tree.prototype.Expand=function(nid){var self=this;self._ExpandNode(nid);self.ExpandChild(nid);};Tree.prototype.ExpandChild=function(nid){var self=this;var node=self.Node(nid);node.EachCHild(function(i,val){var obj=$("#"+this.id);var isLeaf=this.IsLeaf();if(self.onExpandState){self.onExpandState(obj);}
if(self.onStateChange!=null){var c;var cnid=this.nid;if(obj.attr("childExpanded")!="false"){c=self.onStateChange(obj,true,isLeaf);$(c).click(function(){if(!isLeaf){self.Collapse(cnid);}});}else{c=self.onStateChange(obj,false,isLeaf);$(c).click(function(){if(!isLeaf){self.Expand(cnid);}});}
self.RenderNode(nid,false);}
if(!isLeaf){if(obj.attr("childExpanded")!="false"){self.ExpandChild(this.nid);}else{self.CollapseChild(this.nid);}}});};Tree.prototype.ExpandToLevel=function(level){var self=this;if(level<=0){self.CollapseAll();}else{self.ExpandAll();for(var i=level;i<self.treedeep+1;i++){for(var key in self.arrnodes){var n=self.arrnodes[key];if(n.Level()==i){self.Collapse(n.nid);}}}}}
Tree.prototype.ExpandAll=function(){var self=this;$("#"+this.rootnode.id).attr("childExpanded","true");for(var key in this.arrnodes){var n=this.arrnodes[key];if(n.HasChild()){$("#"+n.id).attr("childExpanded","true");}}
self.Expand(this.rootnode.nid);};Tree.prototype._CollapseNode=function(nid){var self=this;var node=self.Node(nid);var isLeaf=node.IsLeaf();var curobj=$("#"+node.id);curobj.attr("childExpanded","false");if(self.onStateChange!=null){var c=self.onStateChange(curobj,false,isLeaf);if(!isLeaf){$(c).click(function(){self.Expand(nid);});}
self.RenderNode(nid,false);}};Tree.prototype.Collapse=function(nid){var self=this;self._CollapseNode(nid);self.CollapseChild(nid);};Tree.prototype.CollapseChild=function(nid){var self=this;var node=self.Node(nid);node.EachCHild(function(i,val){var obj=$("#"+this.id);var isLeaf=this.IsLeaf();if(self.onCollapseState!=null){self.onCollapseState(obj);}
if(self.onStateChange!=null){var c;var cnid=this.nid;if(obj.attr("childExpanded")!="false"){c=self.onStateChange(obj,true,isLeaf);$(c).click(function(){if(!isLeaf){self.Collapse(cnid);}});}else{c=self.onStateChange(obj,false,isLeaf);$(c).click(function(){if(!isLeaf){self.Expand(cnid);}});}
self.RenderNode(this.nid,false);}
self.CollapseChild(this.nid);});}
Tree.prototype.CollapseToLevel=function(level){var self=this;for(var key in self.arrnodes){var n=self.arrnodes[key];if(n.n.Level()==level){self.Collapse(n.nid);}}}
Tree.prototype.CollapseAll=function(){var self=this;$("#"+this.rootnode.id).attr("childExpanded","false");for(var key in this.arrnodes){var n=this.arrnodes[key];if(n.HasChild()){$("#"+n.id).attr("childExpanded","false");}}
self.Collapse(this.rootnode.nid);};Tree.prototype.HasChildNode=function(nid){var self=this;return self.Node(nid).HasChild();}
return Tree;})();methods={init:function(table,options){var settings,tree,table;this.table=table;settings=$.extend({openTemplate:"<a href='#'>&nbsp;-&nbsp;</a>",closeTempate:"<a href='#'>&nbsp;+&nbsp;</a>",leafTemplate:"<span></span>",rowTag:"tr",nodeIdAttr:"nid",parentIdAttr:"pid",rootId:"root",initialState:"collapsed",subnodeOffset:"10",onExpandState:function(obj){if(obj){$(obj).show();}},onCollapseState:function(obj){if(obj){$(obj).hide();}},onStateChange:function(obj,isExpanded,isLeaf){var self=this;if(obj){var c=$(obj).find("[treeclick='true']");var rep=$(self.openTemplate).attr("treeclick","true");if(isLeaf){rep=$(self.leafTemplate).attr("treeclick","true");}else{if(isExpanded){rep=$(self.openTemplate).attr("treeclick","true");}else{rep=$(self.closeTempate).attr("treeclick","true");}}
c.replaceWith(rep);return rep;}},onLoad:null,onLoadComplete:null},options);var self=this;tree=new Tree(self.table,settings);tree.Load();$(this).data("treetable",tree);return this;},Expand:function(nid){$(this).data("treetable").Expand(nid);return this;},ExpandAll:function(){$(this).data("treetable").ExpandAll();return this;},ExpandToLevel:function(level){$(this).data("treetable").ExpandToLevel(level);return this;},Collapse:function(nid){$(this).data("treetable").Collapse(nid);return this;},CollapseAll:function(){$(this).data("treetable").CollapseAll();return this;},CollapseToLevel:function(level){$(this).data("treetable").CollapseToLevel(level);return this;},Destory:function(){}}
$.fn.treetable=function(options){return methods.init(this,options);}})(jQuery,FrameNameSpace);